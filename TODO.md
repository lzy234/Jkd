# Excel订单管理COM加载项开发计划

## 1. 开发环境准备

- [ ] 安装Visual Studio 2019/2022
- [ ] 安装.NET Framework 4.7.2或更高版本
- [ ] 安装Windows SDK
- [ ] 创建C#类库项目（.NET Framework）
- [ ] 配置项目为COM可见

## 2. 核心框架搭建

- [ ] 创建项目基础结构:
  - [ ] Connect类（实现IDTExtensibility2接口）
  - [ ] Services文件夹（业务服务）
  - [ ] Models文件夹（数据模型）
  - [ ] Forms文件夹（窗体界面）
  - [ ] Utils文件夹（工具类）
- [ ] 添加必要的NuGet包:
  - [ ] Newtonsoft.Json (JSON处理)
  - [ ] System.Net.Http (HTTP请求)
- [ ] 添加COM引用:
  - [ ] Microsoft.Office.Interop.Excel
  - [ ] Extensibility
  - [ ] Microsoft.Office.Core
- [ ] 配置项目属性:
  - [ ] 勾选"为COM互操作注册"
  - [ ] 创建强名称密钥文件
  - [ ] 设置ComVisible为true
- [ ] 生成项目GUID
- [ ] 配置AssemblyInfo.cs

## 3. COM加载项基础实现

- [ ] 实现Connect类:
  - [ ] 实现OnConnection方法
  - [ ] 实现OnDisconnection方法
  - [ ] 实现其他IDTExtensibility2接口方法
- [ ] 创建自定义菜单:
  - [ ] 创建CommandBar菜单栏
  - [ ] 添加菜单按钮
  - [ ] 绑定按钮事件处理器
- [ ] 实现菜单清理逻辑
- [ ] 实现COM对象释放机制

## 4. API客户端实现

- [ ] 创建HTTP客户端基类
- [ ] 实现登录认证API:
  - [ ] 编码凭据函数（需逆向分析原应用）
  - [ ] 登录请求处理
  - [ ] 令牌存储机制
  - [ ] 添加所有必要的HTTP头
- [ ] 实现订单列表API:
  - [ ] 请求参数构建
  - [ ] 响应数据解析
  - [ ] 分页处理
- [ ] 实现订单备注修改API
- [ ] 实现派送人修改API
- [ ] 添加API错误处理机制
- [ ] 实现请求重试机制

## 5. 数据模型定义

- [ ] 创建API响应模型类:
  - [ ] LoginResponse和LoginData
  - [ ] OrderListResponse和OrderListData
  - [ ] BasicResponse
- [ ] 创建业务模型类:
  - [ ] Order
  - [ ] ContactInfo
  - [ ] OrderItem
  - [ ] Dispatcher
- [ ] 实现数据转换助手类
- [ ] 添加数据验证逻辑

## 6. 用户界面开发

- [ ] 创建登录窗体（LoginForm）:
  - [ ] 设计窗体布局
  - [ ] 添加用户名和密码输入框
  - [ ] 实现登录按钮事件
  - [ ] 添加状态显示标签
- [ ] 创建设置窗体（可选）:
  - [ ] API端点配置
  - [ ] 日志级别设置
- [ ] 实现工作表数据展示:
  - [ ] 创建表头
  - [ ] 设置单元格格式
  - [ ] 应用样式
  - [ ] 创建Excel表格对象
- [ ] 实现下拉列表（派送人选择）
- [ ] 添加数据验证

## 7. 业务逻辑实现

- [ ] 实现AuthenticationService:
  - [ ] 登录流程
  - [ ] 令牌管理
  - [ ] 会话保持
  - [ ] 自动重连机制
- [ ] 实现OrderService:
  - [ ] 获取订单列表
  - [ ] 筛选和分页
  - [ ] 数据展示到工作表
  - [ ] 格式化处理
- [ ] 实现OrderUpdateService:
  - [ ] 备注更新
  - [ ] 派送人更新
  - [ ] 批量操作支持
  - [ ] 更新结果反馈
- [ ] 实现日志记录系统:
  - [ ] Logger类
  - [ ] 日志文件管理
  - [ ] 异常记录

## 8. Excel工作表交互功能

- [ ] 实现工作表变更事件处理:
  - [ ] 注册SheetChange事件
  - [ ] 备注修改监听
  - [ ] 派送人修改监听
  - [ ] 防止重复触发
- [ ] 实现状态指示器更新
- [ ] 添加单元格锁定（保护订单ID列）
- [ ] 实现异步更新机制
- [ ] 添加UI线程调用处理

## 9. 注册和部署准备

- [ ] 创建注册表配置文件（Register.reg）:
  - [ ] 设置LoadBehavior
  - [ ] 配置Description和FriendlyName
- [ ] 创建安装脚本（Install.bat）:
  - [ ] 复制DLL文件
  - [ ] 执行RegAsm注册
  - [ ] 导入注册表
- [ ] 创建卸载脚本（Uninstall.bat）:
  - [ ] 注销COM组件
  - [ ] 删除注册表项
  - [ ] 清理文件
- [ ] 使用Inno Setup创建安装包:
  - [ ] 编写Setup.iss脚本
  - [ ] 配置文件复制
  - [ ] 配置注册表写入
  - [ ] 配置COM注册
  - [ ] 生成安装程序

## 10. 调试和测试

- [ ] 配置调试环境:
  - [ ] 设置启动程序为EXCEL.EXE
  - [ ] 以管理员权限运行VS
- [ ] 功能测试:
  - [ ] 测试加载项加载
  - [ ] 测试菜单显示
  - [ ] 测试登录功能
  - [ ] 测试订单获取
  - [ ] 测试备注修改
  - [ ] 测试派送人修改
  - [ ] 测试异常处理
- [ ] 兼容性测试:
  - [ ] Excel 2010
  - [ ] Excel 2013
  - [ ] Excel 2016
  - [ ] Excel 2019
  - [ ] Office 365
- [ ] 性能测试:
  - [ ] 大量订单加载
  - [ ] 并发修改处理
- [ ] 清理测试:
  - [ ] 测试卸载脚本
  - [ ] 验证注册表清理
  - [ ] 验证文件清理

## 11. 文档编写

- [ ] 编写用户手册:
  - [ ] 安装指南（含管理员权限说明）
  - [ ] 功能介绍
  - [ ] 常见问题解答
  - [ ] 故障排查指南
- [ ] 编写开发文档:
  - [ ] 架构说明
  - [ ] API文档
  - [ ] 数据模型说明
  - [ ] COM注册原理
- [ ] 创建版本说明文档
- [ ] 编写部署文档

## 12. 优化和增强（可选）

- [ ] 添加配置文件支持
- [ ] 实现多语言支持
- [ ] 添加自动更新检查
- [ ] 实现离线缓存
- [ ] 添加数据导出功能
- [ ] 优化大数据量处理
- [ ] 添加操作撤销功能

## 注意事项

1. **开发环境**：必须以管理员权限运行Visual Studio才能注册COM组件
2. **调试**：每次修改代码后需要重新注册COM组件
3. **版本管理**：修改版本号后需要更新GUID
4. **依赖项**：确保目标机器已安装.NET Framework 4.7.2+
5. **安全性**：凭据加密需要与原应用保持一致
6. **日志**：生产环境要控制日志大小，避免占用过多磁盘空间